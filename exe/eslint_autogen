#!/usr/bin/env ruby
# frozen_string_literal: true

require 'active_support/all'
require 'pry'

TODO_FILE_PATH = './.eslint_todo.yml'
HEADING = <<~COMMENTS.freeze
  # This configuration was generated by `exe/eslint_autogen`
  # on #{Time.now.utc}.
  # The point is for the user to remove these configuration records
  # one by one as the offenses are removed from the code base.
COMMENTS
MAX_FILES_FOR_OVERRIDES = 400

File.write(TODO_FILE_PATH, '')
json = `yarn --silent eslint --format json`
results = JSON.parse(json)

by_rule =
  results.each_with_object({}) do |result, hash|
    result.fetch('messages').each do |message|
      hash[message.fetch('ruleId')] ||= []
      hash[message.fetch('ruleId')] << result.fetch('filePath')
    end
  end

overrides, disables =
  by_rule.sort_by(&:first).partition do |_rule, file_paths|
    file_paths.uniq.length <= MAX_FILES_FOR_OVERRIDES
  end

output = StringIO.new
output.puts(HEADING)
output.puts
output.puts('overrides:')

overrides.each do |rule, file_paths|
  output.puts
  output.puts("  # Offense count: #{file_paths.length}")
  output.puts("  - rules: { '#{rule}': off }")
  output.puts('    files:')

  file_paths.uniq.sort.each do |file_path|
    output.puts("    - #{file_path.sub("#{Dir.pwd}/", '')}")
  end
end

if disables.any?
  output.puts
  output.puts('rules:')

  disables.each do |rule, file_paths|
    output.puts
    output.puts("  # Offense count: #{file_paths.length}")
    output.puts("  '#{rule}': off")
  end
end

File.write(TODO_FILE_PATH, output.string)
